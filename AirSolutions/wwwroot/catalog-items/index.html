<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Catálogo de Items - AirSolutions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/site.css" rel="stylesheet">
</head>
<body class="landing-bizland module-page">
  <header class="main-header sticky-top">
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand brand-mark brand-with-logo" href="/admin/"><img src="/logo.png" alt="AirSolutions logo"><span class="brand-title">Air<span>Solutions</span></span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            <li class="nav-item"><a class="nav-link" href="/admin/">Inicio</a></li>
            <li class="nav-item"><a class="nav-link" href="../clients/">Clientes</a></li>
            <li class="nav-item"><a class="nav-link active" href="../catalog-items/">Catálogo</a></li>
            <li class="nav-item"><a class="nav-link" href="../quotes/">Cotizaciones</a></li>
            <li class="nav-item"><a class="nav-link" href="../invoices/">Facturación</a></li>
            <li class="nav-item">
              <button id="openLoginBtn" type="button" class="btn btn-sm btn-outline-brand ms-lg-2">Iniciar sesión</button>
            </li>
            <li class="nav-item d-none" id="welcomeItem">
              <span id="welcomeText" class="nav-link mb-0"></span>
            </li>
            <li class="nav-item d-none" id="logoutItem">
              <button id="logoutBtn" type="button" class="btn btn-sm btn-outline-secondary">Cerrar sesión</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
<main class="container my-4">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4">
      <h1 class="h2 mb-0">Catálogo de Items</h1>
      <a class="btn btn-primary" href="create.html">Nuevo item</a>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="formSearch" class="row g-2">
          <div class="col-md-4">
            <label class="form-label visually-hidden">Buscar</label>
            <input type="text" class="form-control" id="search" name="search" placeholder="Nombre, descripción o SKU...">
          </div>
          <div class="col-md-3">
            <label class="form-label visually-hidden">Tipo</label>
            <select class="form-select" id="filterType" name="itemType">
              <option value="">Todos los tipos</option>
              <option value="Service">Servicio</option>
              <option value="Product">Producto</option>
              <option value="Material">Material</option>
              <option value="Other">Otro</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label visually-hidden">Estado</label>
            <select class="form-select" id="filterActive" name="isActive">
              <option value="">Todos</option>
              <option value="true">Activos</option>
              <option value="false">Inactivos</option>
            </select>
          </div>
          <div class="col-md-1">
            <button type="submit" class="btn btn-outline-primary w-100">Buscar</button>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-outline-secondary w-100" id="btnClear">Limpiar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="alertPlaceholder"></div>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th>Id</th>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Nivel</th>
            <th>SKU</th>
            <th>Precio Base</th>
            <th>Costo</th>
            <th>Activo</th>
            <th class="text-end">Acciónes</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" class="text-center text-muted">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/auth-ui.js"></script>
  <script>
    const API = '/api/catalogitems';
    const tbody = document.getElementById('tbody');
    const formSearch = document.getElementById('formSearch');
    const searchInput = document.getElementById('search');
    const filterType = document.getElementById('filterType');
    const filterActive = document.getElementById('filterActive');
    const btnClear = document.getElementById('btnClear');
    const alertPlaceholder = document.getElementById('alertPlaceholder');

    function showAlert(message, type = 'danger') {
      alertPlaceholder.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
    }

    function loadItems() {
      alertPlaceholder.innerHTML = '';
      const params = new URLSearchParams();
      const search = searchInput.value.trim();
      const itemType = filterType.value;
      const isActive = filterActive.value;
      if (search) params.set('search', search);
      if (itemType) params.set('itemType', itemType);
      if (isActive) params.set('isActive', isActive);
      const url = params.toString() ? API + '?' + params : API;

      tbody.innerHTML = '<tr><td colspan="9" class="text-center">Cargando...</td></tr>';
      fetch(url)
        .then(r => {
          if (r.status === 401) throw new Error('AUTH_REQUIRED');
          if (!r.ok) throw new Error('LOAD_ERROR');
          return r.json();
        })
        .then(data => {
          alertPlaceholder.innerHTML = '';
          if (data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No hay items.</td></tr>';
            return;
          }
          tbody.innerHTML = data.map(item => {
            const typeNames = { Service: 'Servicio', Product: 'Producto', Material: 'Material', Other: 'Otro' };
            return '<tr>' +
              '<td>' + item.id + '</td>' +
              '<td>' + escapeHtml(item.name || '-') + '</td>' +
              '<td>' + (typeNames[item.itemType] || item.itemType) + '</td>' +
              '<td>' + (item.nivel || '-') + '</td>' +
              '<td>' + escapeHtml(item.sku || '-') + '</td>' +
              '<td>' + (item.basePrice != null ? '$' + parseFloat(item.basePrice).toFixed(2) : '-') + '</td>' +
              '<td>' + (item.cost != null ? '$' + parseFloat(item.cost).toFixed(2) : '-') + '</td>' +
              '<td>' + (item.isActive ? '<span class="badge bg-success">Sí</span>' : '<span class="badge bg-secondary">No</span>') + '</td>' +
              '<td class="text-end"><a class="btn btn-sm btn-outline-info me-1" href="view.html?id=' + item.id + '">Ver</a><a class="btn btn-sm btn-outline-primary me-1" href="edit.html?id=' + item.id + '">Editar</a><button type="button" class="btn btn-sm btn-outline-danger" data-id="' + item.id + '" data-name="' + escapeHtml(item.name) + '">Eliminar</button></td>' +
              '</tr>';
          }).join('');
          tbody.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', () => deleteItem(btn.dataset.id, btn.dataset.name));
          });
        })
        .catch((err) => {
          if (err && err.message === 'AUTH_REQUIRED') {
            showAlert('Debes iniciar sesión para ver esta información.', 'warning');
            tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Inicia sesión para mostrar la lista.</td></tr>';
            return;
          }
          tbody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Error al cargar la lista.</td></tr>';
        });
    }

    function escapeHtml(s) {
      const div = document.createElement('div');
      div.textContent = s;
      return div.innerHTML;
    }

    function deleteItem(id, name) {
      if (!confirm('¿Eliminar el item "' + name + '"?')) return;
      fetch(API + '/' + id, { method: 'DELETE' })
        .then(r => { if (!r.ok) throw new Error(); loadItems(); showAlert('Item eliminado.', 'success'); })
        .catch(() => showAlert('No se pudo eliminar.', 'danger'));
    }

    window.addEventListener('airsolutions:auth', (event) => {
      if (event && event.detail && event.detail.loggedIn) {
        alertPlaceholder.innerHTML = '';
        loadItems();
      }
    });

    window.airsolutionsRefresh = () => {
      alertPlaceholder.innerHTML = '';
      loadItems();
    };

    formSearch.addEventListener('submit', e => { e.preventDefault(); loadItems(); });
    btnClear.addEventListener('click', () => { searchInput.value = ''; filterType.value = ''; filterActive.value = ''; loadItems(); });
    loadItems();
  </script>
</body>
</html>






