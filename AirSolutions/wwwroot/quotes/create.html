<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Nueva cotización - AirSolutions</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/site.css" rel="stylesheet">
</head>
<body class="landing-bizland module-page">
  <header class="main-header sticky-top">
    <nav class="navbar navbar-expand-lg navbar-light">
      <div class="container">
        <a class="navbar-brand brand-mark" href="/">Air<span>Solutions</span></a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav ms-auto align-items-lg-center gap-lg-2">
            <li class="nav-item"><a class="nav-link" href="/">Inicio</a></li>
            <li class="nav-item"><a class="nav-link" href="../clients/">Clientes</a></li>
            <li class="nav-item"><a class="nav-link" href="../catalog-items/">Catálogo</a></li>
            <li class="nav-item"><a class="nav-link active" href="../quotes/">Cotizaciónes</a></li>
            <li class="nav-item">
              <button id="openLoginBtn" type="button" class="btn btn-sm btn-outline-brand ms-lg-2">Iniciar sesión</button>
            </li>
            <li class="nav-item d-none" id="welcomeItem">
              <span id="welcomeText" class="nav-link mb-0"></span>
            </li>
            <li class="nav-item d-none" id="logoutItem">
              <button id="logoutBtn" type="button" class="btn btn-sm btn-outline-secondary">Cerrar sesión</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
  </header>
<main class="container my-4">
    <div class="d-flex align-items-center gap-2 mb-4 flex-wrap">
      <a class="btn btn-outline-secondary btn-sm" href="index.html">Volver</a>
      <h1 class="h2 mb-0">Nueva cotización</h1>
    </div>

    <div id="alertPlaceholder"></div>

    <form id="formQuote" class="needs-validation" novalidate>
      <div class="card mb-3">
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" id="name" maxlength="300" placeholder="Ej: Cotización AA-001">
            </div>
            <div class="col-md-6">
              <label class="form-label">Crear desde plantilla</label>
              <div class="input-group">
                <select class="form-select" id="templateQuoteId">
                  <option value="">Sin plantilla</option>
                </select>
                <button class="btn btn-outline-secondary" type="button" id="btnApplyTemplate">Cargar</button>
              </div>
              <div class="form-text">Copia nombre, descripción y líneas de una cotización existente.</div>
            </div>
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" id="description" rows="2" maxlength="1000"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span class="fw-semibold">Cliente</span>
          <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalNewClient">Nuevo cliente</button>
        </div>
        <div class="card-body">
          <input type="hidden" id="clientId" required>
          <div class="row g-2">
            <div class="col-md-8 position-relative">
              <label class="form-label">Buscar cliente</label>
              <input type="text" class="form-control" id="clientSearch" placeholder="Nombre, empresa o teléfono..." autocomplete="off">
              <div id="clientResults" class="list-group position-absolute w-100 shadow-sm" style="z-index: 1050;"></div>
            </div>
            <div class="col-md-4 d-flex align-items-end">
              <button type="button" class="btn btn-outline-secondary w-100" id="btnClearClient">Limpiar seleccion</button>
            </div>
          </div>
          <div id="selectedClient" class="mt-3 text-muted">No hay cliente seleccionado.</div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-header bg-light d-flex justify-content-between align-items-center flex-wrap gap-2">
          <span class="fw-semibold">Líneas de cotización</span>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="btnAddLine">Agregar línea manual</button>
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalCatalog">Agregar línea desde catálogo</button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered align-middle" id="linesTable">
              <thead class="table-light">
                <tr>
                  <th style="min-width: 180px;">Nombre</th>
                  <th style="min-width: 220px;">Descripción</th>
                  <th style="width: 110px;">Cantidad</th>
                  <th style="width: 140px;">Precio unitario</th>
                  <th style="width: 120px;">Desc %</th>
                  <th style="width: 90px;">ITBIS</th>
                  <th style="width: 120px;">ITBIS %</th>
                  <th style="width: 130px;">Total línea</th>
                  <th style="width: 80px;"></th>
                </tr>
              </thead>
              <tbody id="linesBody">
                <tr><td colspan="9" class="text-center text-muted">Aún no hay líneas.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="row justify-content-end">
            <div class="col-md-4">
              <table class="table table-sm mb-0">
                <tr><th>Subtotal</th><td class="text-end" id="summarySubtotal">RD$ 0.00</td></tr>
                <tr><th>Descuento</th><td class="text-end" id="summaryDiscount">RD$ 0.00</td></tr>
                <tr><th>ITBIS</th><td class="text-end" id="summaryTax">RD$ 0.00</td></tr>
                <tr class="table-light fw-semibold"><th>Total</th><td class="text-end" id="summaryTotal">RD$ 0.00</td></tr>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Guardar cotización</button>
        <a class="btn btn-outline-secondary" href="index.html">Cancelar</a>
      </div>
    </form>
  </main>

  <div class="modal fade" id="modalNewClient" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="formNewClient" class="needs-validation" novalidate>
          <div class="modal-header">
            <h2 class="modal-title fs-5">Nuevo cliente</h2>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Tipo</label>
                <select class="form-select" name="clientType" required>
                  <option value="Individual">Individual</option>
                  <option value="Company">Empresa</option>
                </select>
              </div>
              <div class="col-md-6" id="wrapCompanyName" style="display:none;">
                <label class="form-label">Empresa</label>
                <input type="text" class="form-control" name="companyName" maxlength="300">
              </div>
              <div class="col-md-6">
                <label class="form-label">Nombre</label>
                <input type="text" class="form-control" name="firstName" required maxlength="200">
              </div>
              <div class="col-md-6">
                <label class="form-label">Apellido</label>
                <input type="text" class="form-control" name="lastName" maxlength="200">
              </div>
              <div class="col-md-6">
                <label class="form-label">Teléfono</label>
                <input type="text" class="form-control" name="phone" required maxlength="50">
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" name="email" maxlength="200">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Crear cliente</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalCatalog" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title fs-5">Agregar línea desde catálogo</h2>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-md-6">
              <input type="text" class="form-control" id="catalogSearch" placeholder="Buscar por nombre, descripción o SKU...">
            </div>
            <div class="col-md-3">
              <select class="form-select" id="catalogType">
                <option value="">Todos los tipos</option>
                <option value="Service">Servicio</option>
                <option value="Product">Producto</option>
                <option value="Material">Material</option>
                <option value="Other">Otro</option>
              </select>
            </div>
            <div class="col-md-3">
              <button type="button" class="btn btn-outline-primary w-100" id="btnSearchCatalog">Buscar</button>
            </div>
          </div>

          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th>Nombre</th>
                  <th>Tipo</th>
                  <th>SKU</th>
                  <th>Precio base</th>
                  <th>ITBIS</th>
                  <th class="text-end">Acción</th>
                </tr>
              </thead>
              <tbody id="catalogBody">
                <tr><td colspan="6" class="text-center text-muted">Cargando...</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/auth-ui.js"></script>
  <script>
    const API_QUOTES = '/api/quotes';
    const API_CLIENTS = '/api/clients';
    const API_CATALOG = '/api/catalogitems';
    const DEFAULT_TAX_RATE = 18;

    const state = {
      lines: [],
      selectedClient: null,
      quotes: []
    };
    const PREFILL_KEY = 'quote_prefill';
    const MISSING_KEY = 'quote_missing_fields';

    const alertPlaceholder = document.getElementById('alertPlaceholder');
    const formQuote = document.getElementById('formQuote');
    const linesBody = document.getElementById('linesBody');
    const clientSearch = document.getElementById('clientSearch');
    const clientResults = document.getElementById('clientResults');
    const selectedClient = document.getElementById('selectedClient');
    const templateQuoteId = document.getElementById('templateQuoteId');
    const modalNewClientElement = document.getElementById('modalNewClient');
    const modalCatalogElement = document.getElementById('modalCatalog');
    const formNewClient = document.getElementById('formNewClient');
    const wrapCompanyName = document.getElementById('wrapCompanyName');
    const newClientModal = new bootstrap.Modal(modalNewClientElement);
    const catalogModal = new bootstrap.Modal(modalCatalogElement);

    function showAlert(message, type = 'danger') {
      alertPlaceholder.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
    }

    function escapeHtml(value) {
      const div = document.createElement('div');
      div.textContent = value || '';
      return div.innerHTML;
    }

    function parseNumber(value, fallback = 0) {
      const parsed = parseFloat(value);
      return isNaN(parsed) ? fallback : parsed;
    }

    function formatMoney(value) {
      return 'RD$ ' + (parseNumber(value).toFixed(2));
    }

    function getClientName(client) {
      if (!client) return '-';
      if (client.clientType === 'Company') return client.companyName || '-';
      const fullName = ((client.firstName || '') + ' ' + (client.lastName || '')).trim();
      return fullName || '-';
    }

    function getLineTotals(line) {
      const subtotal = parseNumber(line.quantity) * parseNumber(line.unitPrice);
      const discountTotal = subtotal * (parseNumber(line.discountValue) / 100);
      const baseAfterDiscount = subtotal - discountTotal;
      const taxTotal = line.isTaxable ? baseAfterDiscount * (parseNumber(line.taxRate) / 100) : 0;
      const total = baseAfterDiscount + taxTotal;
      return { subtotal, discountTotal, taxTotal, total };
    }

    function renderClientSelection() {
      const input = document.getElementById('clientId');
      if (!state.selectedClient) {
        input.value = '';
        selectedClient.innerHTML = '<span class="text-danger">Selecciona un cliente para continuar.</span>';
        return;
      }
      input.value = state.selectedClient.id;
      selectedClient.innerHTML = '<div class="alert alert-info mb-0">Cliente seleccionado: <strong>' + escapeHtml(getClientName(state.selectedClient)) + '</strong> <small class="text-muted">(ID: ' + state.selectedClient.id + ')</small></div>';
    }

    function renderLines() {
      if (!state.lines.length) {
        linesBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">Aún no hay líneas.</td></tr>';
        renderSummary();
        return;
      }

      linesBody.innerHTML = state.lines.map((line, index) => {
        const totals = getLineTotals(line);
        return '<tr data-index="' + index + '">' +
          '<td><input type="text" class="form-control form-control-sm" data-field="name" value="' + escapeHtml(line.name) + '" required></td>' +
          '<td><input type="text" class="form-control form-control-sm" data-field="description" value="' + escapeHtml(line.description || '') + '"></td>' +
          '<td><input type="number" min="0.01" step="0.01" class="form-control form-control-sm" data-field="quantity" value="' + parseNumber(line.quantity, 1) + '"></td>' +
          '<td><input type="number" min="0" step="0.01" class="form-control form-control-sm" data-field="unitPrice" value="' + parseNumber(line.unitPrice).toFixed(2) + '"></td>' +
          '<td><input type="number" min="0" max="100" step="0.01" class="form-control form-control-sm" data-field="discountValue" value="' + parseNumber(line.discountValue).toFixed(2) + '"></td>' +
          '<td class="text-center"><input type="checkbox" class="form-check-input" data-field="isTaxable" ' + (line.isTaxable ? 'checked' : '') + '></td>' +
          '<td><input type="number" min="0" max="100" step="0.01" class="form-control form-control-sm" data-field="taxRate" value="' + parseNumber(line.taxRate).toFixed(2) + '" ' + (!line.isTaxable ? 'disabled' : '') + '></td>' +
          '<td class="text-end fw-semibold">' + formatMoney(totals.total) + '</td>' +
          '<td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger" data-action="remove">Quitar</button></td>' +
          '</tr>';
      }).join('');

      linesBody.querySelectorAll('tr').forEach(row => {
        const index = parseInt(row.dataset.index, 10);
        row.querySelectorAll('[data-field]').forEach(input => {
          const field = input.dataset.field;
          input.addEventListener(field === 'isTaxable' ? 'change' : 'input', e => {
            if (field === 'isTaxable') {
              state.lines[index][field] = e.target.checked;
              if (!state.lines[index][field]) {
                state.lines[index].taxRate = 0;
              } else if (parseNumber(state.lines[index].taxRate) === 0) {
                state.lines[index].taxRate = DEFAULT_TAX_RATE;
              }
            } else if (['quantity', 'unitPrice', 'discountValue', 'taxRate'].includes(field)) {
              state.lines[index][field] = parseNumber(e.target.value, 0);
            } else {
              state.lines[index][field] = e.target.value;
            }
            renderLines();
          });
        });

        row.querySelector('[data-action="remove"]').addEventListener('click', () => {
          state.lines.splice(index, 1);
          renderLines();
        });
      });

      renderSummary();
    }

    function renderSummary() {
      let subtotal = 0;
      let discount = 0;
      let tax = 0;
      let total = 0;

      state.lines.forEach(line => {
        const totals = getLineTotals(line);
        subtotal += totals.subtotal;
        discount += totals.discountTotal;
        tax += totals.taxTotal;
        total += totals.total;
      });

      document.getElementById('summarySubtotal').textContent = formatMoney(subtotal);
      document.getElementById('summaryDiscount').textContent = formatMoney(discount);
      document.getElementById('summaryTax').textContent = formatMoney(tax);
      document.getElementById('summaryTotal').textContent = formatMoney(total);
    }

    function addLineFromCatalog(item) {
      state.lines.push({
        name: item.name || '',
        description: item.description || '',
        quantity: 1,
        unitPrice: parseNumber(item.basePrice, 0),
        discountValue: 0,
        isTaxable: item.isTaxable === true,
        taxRate: item.isTaxable === true ? DEFAULT_TAX_RATE : 0
      });
      renderLines();
    }

    function addManualLine() {
      state.lines.push({
        name: '',
        description: '',
        quantity: 1,
        unitPrice: 0,
        discountValue: 0,
        isTaxable: false,
        taxRate: 0
      });
      renderLines();
    }

    async function applyAssistantPrefill() {
      const raw = sessionStorage.getItem(PREFILL_KEY);
      if (!raw) return;

      let prefill = null;
      try {
        prefill = JSON.parse(raw);
      } catch {
        sessionStorage.removeItem(PREFILL_KEY);
        sessionStorage.removeItem(MISSING_KEY);
        return;
      }

      const serviceType = (prefill.serviceType || '').trim();
      const workArea = (prefill.workArea || '').trim();
      const materialsOrNotes = (prefill.materialsOrNotes || '').trim();
      const clientName = (prefill.clientName || '').trim();
      const clientId = prefill.clientId;
      const phone = (prefill.phone || '').trim();
      const address = (prefill.address || '').trim();
      const quantity = prefill.quantity;
      const unitPrice = prefill.unitPrice;
      const catalogLines = Array.isArray(prefill.catalogLines) ? prefill.catalogLines : [];

      if (serviceType && !document.getElementById('name').value.trim()) {
        document.getElementById('name').value = 'Cotización de ' + serviceType;
      }

      const details = [];
      if (serviceType) details.push('Servicio: ' + serviceType);
      if (workArea) details.push('Area: ' + workArea);
      if (materialsOrNotes) details.push('Notas: ' + materialsOrNotes);
      if (phone) details.push('Teléfono: ' + phone);
      if (address) details.push('Dirección: ' + address);
      if (quantity != null) details.push('Cantidad: ' + quantity);
      if (unitPrice != null) details.push('Precio unitario: ' + unitPrice);

      if (details.length) {
        const current = document.getElementById('description').value.trim();
        const generated = details.join(' | ');
        document.getElementById('description').value = current ? (current + '\n' + generated) : generated;
      }

      if (clientId != null) {
        try {
          const response = await fetch(API_CLIENTS + '/' + clientId);
          if (response.ok) {
            const client = await response.json();
            state.selectedClient = client;
            clientSearch.value = getClientName(client);
            renderClientSelection();
          } else if (clientName && !clientSearch.value.trim()) {
            clientSearch.value = clientName;
          }
        } catch {
          if (clientName && !clientSearch.value.trim()) {
            clientSearch.value = clientName;
          }
        }
      } else if (clientName && !clientSearch.value.trim()) {
        clientSearch.value = clientName;
      }

      if (catalogLines.length) {
        catalogLines.forEach(line => {
          state.lines.push({
            name: line.name || '',
            description: line.description || '',
            quantity: parseNumber(line.quantity, 1),
            unitPrice: parseNumber(line.unitPrice, 0),
            discountValue: 0,
            isTaxable: line.isTaxable === true,
            taxRate: line.isTaxable === true ? parseNumber(line.taxRate, DEFAULT_TAX_RATE) : 0
          });
        });
        renderLines();
      }

      let missingFields = [];
      try {
        missingFields = JSON.parse(sessionStorage.getItem(MISSING_KEY) || '[]');
      } catch {
        missingFields = [];
      }

      const missingLabel = Array.isArray(missingFields) && missingFields.length
        ? '<br><strong>Faltantes:</strong> ' + missingFields.join(', ')
        : '';
      showAlert('Se aplicaron datos detectados por el asistente. Revisa y completa la informacion necesaria.' + missingLabel, 'info');

      sessionStorage.removeItem(PREFILL_KEY);
      sessionStorage.removeItem(MISSING_KEY);
    }

    async function searchClients(term) {
      const params = new URLSearchParams();
      params.set('isActive', 'true');
      if (term) params.set('search', term);

      const response = await fetch(API_CLIENTS + '?' + params.toString());
      if (!response.ok) throw new Error('No se pudo cargar clientes');
      return response.json();
    }

    async function loadTemplateOptions() {
      const response = await fetch(API_QUOTES);
      if (!response.ok) return;
      state.quotes = await response.json();
      templateQuoteId.innerHTML = '<option value="">Sin plantilla</option>' + state.quotes.map(q => {
        return '<option value="' + q.id + '">#' + q.id + ' - ' + escapeHtml(q.name || 'Sin nombre') + '</option>';
      }).join('');
    }

    async function applyTemplate() {
      const id = templateQuoteId.value;
      if (!id) {
        showAlert('Selecciona una plantilla primero.', 'warning');
        return;
      }

      const shouldReplace = !state.lines.length || confirm('Esto reemplazara las líneas actuales. Deseas continuar?');
      if (!shouldReplace) return;

      try {
        const response = await fetch(API_QUOTES + '/' + id);
        if (!response.ok) throw new Error('No se pudo cargar plantilla');
        const quote = await response.json();
        document.getElementById('name').value = quote.name || '';
        document.getElementById('description').value = quote.description || '';
        state.lines = (quote.lines || []).map(line => ({
          name: line.name || '',
          description: line.description || '',
          quantity: parseNumber(line.quantity, 1),
          unitPrice: parseNumber(line.unitPrice, 0),
          discountValue: parseNumber(line.discountValue, 0),
          isTaxable: line.isTaxable === true,
          taxRate: parseNumber(line.taxRate, 0)
        }));
        renderLines();
        showAlert('Plantilla aplicada.', 'success');
      } catch {
        showAlert('No se pudo aplicar la plantilla.');
      }
    }

    function válidateBeforeSubmit() {
      if (!state.selectedClient || !state.selectedClient.id) {
        showAlert('Debes seleccionar un cliente.');
        return false;
      }

      if (!state.lines.length) {
        showAlert('Debes agregar al menos una línea.');
        return false;
      }

      const invalidLine = state.lines.find(line => !line.name || parseNumber(line.quantity) <= 0 || parseNumber(line.unitPrice) < 0 || parseNumber(line.discountValue) < 0 || parseNumber(line.discountValue) > 100 || parseNumber(line.taxRate) < 0 || parseNumber(line.taxRate) > 100);
      if (invalidLine) {
        showAlert('Revisa las líneas: nombre, cantidad, precio, descuento e ITBIS deben ser validos.');
        return false;
      }

      return true;
    }

    function buildPayload() {
      return {
        fromQuoteId: templateQuoteId.value ? parseInt(templateQuoteId.value, 10) : null,
        clientId: state.selectedClient.id,
        name: document.getElementById('name').value.trim() || null,
        description: document.getElementById('description').value.trim() || null,
        lines: state.lines.map(line => ({
          name: line.name.trim(),
          description: line.description ? line.description.trim() : null,
          quantity: parseNumber(line.quantity),
          unitPrice: parseNumber(line.unitPrice),
          discountValue: parseNumber(line.discountValue),
          isTaxable: line.isTaxable === true,
          taxRate: parseNumber(line.taxRate)
        }))
      };
    }

    async function loadCatalog() {
      const search = document.getElementById('catalogSearch').value.trim();
      const itemType = document.getElementById('catalogType').value;
      const params = new URLSearchParams();
      params.set('isActive', 'true');
      if (search) params.set('search', search);
      if (itemType) params.set('itemType', itemType);

      const catalogBody = document.getElementById('catalogBody');
      catalogBody.innerHTML = '<tr><td colspan="6" class="text-center">Cargando...</td></tr>';

      try {
        const response = await fetch(API_CATALOG + '?' + params.toString());
        if (!response.ok) throw new Error('No se pudo cargar catálogo');
        const items = await response.json();

        if (!items.length) {
          catalogBody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No hay items para mostrar.</td></tr>';
          return;
        }

        catalogBody.innerHTML = items.map(item => {
          const typeNames = { Service: 'Servicio', Product: 'Producto', Material: 'Material', Other: 'Otro' };
          return '<tr>' +
            '<td><div class="fw-semibold">' + escapeHtml(item.name || '-') + '</div><small class="text-muted">' + escapeHtml(item.description || '-') + '</small></td>' +
            '<td>' + (typeNames[item.itemType] || escapeHtml(item.itemType || '-')) + '</td>' +
            '<td>' + escapeHtml(item.sku || '-') + '</td>' +
            '<td>' + (item.basePrice != null ? formatMoney(item.basePrice) : '-') + '</td>' +
            '<td>' + (item.isTaxable ? 'Si' : 'No') + '</td>' +
            '<td class="text-end"><button type="button" class="btn btn-sm btn-primary" data-item="' + item.id + '">Agregar</button></td>' +
            '</tr>';
        }).join('');

        catalogBody.querySelectorAll('button[data-item]').forEach(btn => {
          btn.addEventListener('click', () => {
            const item = items.find(x => x.id === parseInt(btn.dataset.item, 10));
            if (!item) return;
            addLineFromCatalog(item);
            catalogModal.hide();
          });
        });
      } catch {
        catalogBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error al cargar catálogo.</td></tr>';
      }
    }

    let clientSearchTimer = null;
    clientSearch.addEventListener('input', () => {
      if (clientSearchTimer) clearTimeout(clientSearchTimer);
      clientSearchTimer = setTimeout(async () => {
        const term = clientSearch.value.trim();
        if (term.length < 2) {
          clientResults.innerHTML = '';
          return;
        }

        try {
          const clients = await searchClients(term);
          if (!clients.length) {
            clientResults.innerHTML = '<div class="list-group-item text-muted">Sin resultados</div>';
            return;
          }

          clientResults.innerHTML = clients.slice(0, 8).map(client => {
            return '<button type="button" class="list-group-item list-group-item-action" data-id="' + client.id + '">' +
              '<div class="fw-semibold">' + escapeHtml(getClientName(client)) + '</div>' +
              '<small class="text-muted">' + escapeHtml(client.phone || '-') + '</small>' +
              '</button>';
          }).join('');

          clientResults.querySelectorAll('button[data-id]').forEach(btn => {
            btn.addEventListener('click', () => {
              const client = clients.find(x => x.id === parseInt(btn.dataset.id, 10));
              if (!client) return;
              state.selectedClient = client;
              clientSearch.value = getClientName(client);
              clientResults.innerHTML = '';
              renderClientSelection();
            });
          });
        } catch {
          clientResults.innerHTML = '<div class="list-group-item text-danger">No se pudo buscar clientes.</div>';
        }
      }, 300);
    });

    document.addEventListener('click', e => {
      if (!clientResults.contains(e.target) && e.target !== clientSearch) {
        clientResults.innerHTML = '';
      }
    });

    document.getElementById('btnClearClient').addEventListener('click', () => {
      state.selectedClient = null;
      clientSearch.value = '';
      clientResults.innerHTML = '';
      renderClientSelection();
    });

    document.getElementById('btnAddLine').addEventListener('click', addManualLine);
    document.getElementById('btnApplyTemplate').addEventListener('click', applyTemplate);
    document.getElementById('btnSearchCatalog').addEventListener('click', loadCatalog);

    modalCatalogElement.addEventListener('shown.bs.modal', () => {
      document.getElementById('catalogSearch').focus();
      loadCatalog();
    });

    formNewClient.querySelector('[name="clientType"]').addEventListener('change', function () {
      const isCompany = this.value === 'Company';
      wrapCompanyName.style.display = isCompany ? 'block' : 'none';
      formNewClient.querySelector('[name="companyName"]').required = isCompany;
    });

    formNewClient.addEventListener('submit', async e => {
      e.preventDefault();
      if (!formNewClient.checkValidity()) {
        formNewClient.classList.add('was-validated');
        return;
      }

      const data = new FormData(formNewClient);
      const payload = {
        clientType: data.get('clientType') || 'Individual',
        firstName: data.get('firstName') || '',
        lastName: data.get('lastName') || null,
        companyName: data.get('companyName') || null,
        phone: data.get('phone') || '',
        email: data.get('email') || null,
        isActive: true,
        createdAt: new Date().toISOString()
      };

      try {
        const response = await fetch(API_CLIENTS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
          showAlert((result.errors && result.errors.join('<br>')) || 'No se pudo crear el cliente.');
          return;
        }

        state.selectedClient = result;
        clientSearch.value = getClientName(result);
        renderClientSelection();
        formNewClient.reset();
        wrapCompanyName.style.display = 'none';
        formNewClient.classList.remove('was-validated');
        newClientModal.hide();
        showAlert('Cliente creado y seleccionado.', 'success');
      } catch {
        showAlert('Error de conexión al crear el cliente.');
      }
    });

    formQuote.addEventListener('submit', async e => {
      e.preventDefault();
      if (!validateBeforeSubmit()) return;

      const payload = buildPayload();
      try {
        const response = await fetch(API_QUOTES, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
          showAlert((result.errors && result.errors.join('<br>')) || 'No se pudo guardar la cotización.');
          return;
        }

        showAlert('Cotización creada correctamente.', 'success');
        setTimeout(() => {
          location.href = 'view.html?id=' + result.id;
        }, 900);
      } catch {
        showAlert('Error de conexión al guardar la cotización.');
      }
    });

    renderClientSelection();
    renderLines();
    loadTemplateOptions();
    applyAssistantPrefill();
  </script>
</body>
</html>




